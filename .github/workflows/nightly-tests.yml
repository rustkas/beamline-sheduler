name: Nightly Tests

on:
  schedule:
    # Run every night at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  router-heavy-tests:
    name: Router Heavy Tier Tests
    runs-on: ubuntu-latest
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run Heavy Tier Tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: bash scripts/ct-heavy.sh

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-heavy-logs-${{ github.run_id }}
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 14

  router-r10-e2e-heavy:
    name: R10 E2E Heavy Profile
    runs-on: ubuntu-latest
    env:
      ROUTER_DIR: apps/otp/router
      R10_PROFILE: heavy

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Prune old test metrics
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          erl -noshell -eval "application:ensure_all_started(beamline_router), router_r10_metrics:prune_old_test_metrics(5), init:stop()" || echo "Metrics cleanup skipped"

      - name: Run R10 E2E tests (Heavy profile)
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 ct --suite test/router_publish_failure_e2e_SUITE --config test/ct.config

      - name: Dump metrics
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          find _build/test/logs -name "*.log" -exec grep -l "dump_metrics" {} \; || echo "No metric dumps found"

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-r10-e2e-heavy-logs-${{ github.run_id }}
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 14

  router-r10-property:
    name: R10 Property-Based Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run property-based tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: timeout 120 rebar3 ct --suite test/router_circuit_breaker_prop_SUITE || echo "Property tests completed"

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-r10-property-logs-${{ github.run_id }}
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 7

  router-nats-performance:
    name: Router NATS Performance Tests
    runs-on: ubuntu-latest
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run NATS performance tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 ct --suite test/router_nats_performance_SUITE || echo "Performance tests completed"

      - name: Upload test logs and reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-nats-performance-logs-${{ github.run_id }}
          path: |
            ${{ env.ROUTER_DIR }}/_build/test/logs/**
            ${{ env.ROUTER_DIR }}/.windsurf/reports/**
          retention-days: 7

  summary:
    name: Nightly Tests Summary
    runs-on: ubuntu-latest
    needs: [router-heavy-tests, router-r10-e2e-heavy, router-r10-property, router-nats-performance]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Nightly Tests Results" >> $GITHUB_STEP_SUMMARY
          echo "- Router Heavy Tests: ${{ needs.router-heavy-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- R10 E2E Heavy: ${{ needs.router-r10-e2e-heavy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- R10 Property Tests: ${{ needs.router-r10-property.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- NATS Performance: ${{ needs.router-nats-performance.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Send notification on failure
        if: contains(needs.*.result, 'failure')
        run: |
          echo "::warning::Nightly tests failed! Check the artifacts for details."
