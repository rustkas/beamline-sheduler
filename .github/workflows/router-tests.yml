name: Router Tests

on:
  push:
    paths:
      - 'apps/otp/router/**'
      - '.github/workflows/router-tests.yml'
  pull_request:
    paths:
      - 'apps/otp/router/**'
      - '.github/workflows/router-tests.yml'

concurrency:
  group: router-${{ github.ref }}
  cancel-in-progress: true

jobs:
  router-ct-fast:
    name: Router Fast Tier Tests
    runs-on: ubuntu-latest
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl jq

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run Fast Tier Tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running Fast Tier Tests..."
          bash scripts/ct-fast.sh || (echo "Fast tests failed" && exit 1)

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-fast-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 7

  router-ct-full:
    name: Router Full Tier Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') || github.event_name == 'pull_request'
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl jq

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run Full Tier Tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running Full Tier Tests..."
          bash scripts/ct-full.sh || (echo "Full tests failed" && exit 1)

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-full-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 7

  router-ct-heavy:
    name: Router Heavy Tier Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl jq

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run Heavy Tier Tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running Heavy Tier Tests..."
          bash scripts/ct-heavy.sh || (echo "Heavy tests failed" && exit 1)

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-heavy-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 14

  router-r10-unit:
    name: R10 Circuit Breaker Unit Tests
    runs-on: ubuntu-latest
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run R10 unit tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running R10 unit tests (circuit breaker logic)..."
          rebar3 ct --suite test/router_circuit_breaker_SUITE || (echo "R10 unit tests failed" && exit 1)

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-r10-unit-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 7

  router-r10-e2e-ci:
    name: R10 E2E Tests (CI Profile)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    env:
      ROUTER_DIR: apps/otp/router
      R10_PROFILE: ci

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run R10 E2E tests (CI profile)
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running R10 E2E tests (CI profile: 10 clients × 20 requests)..."
          rebar3 ct --suite test/router_publish_failure_e2e_SUITE --config test/ct.config || (echo "R10 E2E tests failed" && exit 1)

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-r10-e2e-ci-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 7

  router-r10-e2e-heavy:
    name: R10 E2E Tests (Heavy Profile - Nightly)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      ROUTER_DIR: apps/otp/router
      R10_PROFILE: heavy

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Prune old test metrics
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Pruning old test metrics before E2E run..."
          erl -noshell -eval "application:ensure_all_started(beamline_router), router_r10_metrics:prune_old_test_metrics(5), init:stop()" || echo "Metrics cleanup skipped (app not running)"

      - name: Run R10 E2E tests (Heavy profile)
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running R10 E2E tests (Heavy profile: 50 clients × 100 requests)..."
          rebar3 ct --suite test/router_publish_failure_e2e_SUITE --config test/ct.config || (echo "R10 E2E heavy tests failed" && exit 1)

      - name: Dump metrics for analysis
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Dumping metrics for analysis..."
          find _build/test/logs -name "*.log" -exec grep -l "dump_metrics" {} \; || echo "No metric dumps found"

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-r10-e2e-heavy-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 14

  router-r10-property:
    name: R10 Property-Based Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    continue-on-error: true
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run R10 property-based tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running R10 property-based tests (light mode)..."
          timeout 120 rebar3 ct --suite test/router_circuit_breaker_prop_SUITE || echo "Property tests completed with warnings (non-blocking)"

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-r10-property-logs
          path: ${{ env.ROUTER_DIR }}/_build/test/logs/**
          retention-days: 7

  router-r10-protective-rails:
    name: R10 Protective Rails Validation
    runs-on: ubuntu-latest
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Validate R10 protective rails
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Validating R10 protective rails..."
          bash scripts/check_r10_protective_rails.sh || (echo "Protective rails validation failed" && exit 1)

  router-nats-performance:
    name: Router NATS Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      ROUTER_DIR: apps/otp/router

    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.0'
          rebar3-version: '3.22.0'

      - name: Cache rebar3
        uses: actions/cache@v4
        with:
          path: ~/.cache/rebar3
          key: rebar3-${{ runner.os }}-26.0-${{ hashFiles('**/rebar.lock') }}
          restore-keys: rebar3-${{ runner.os }}-26.0-

      - name: Get dependencies
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 get-deps

      - name: Compile
        working-directory: ${{ env.ROUTER_DIR }}
        run: rebar3 compile

      - name: Run NATS performance tests
        working-directory: ${{ env.ROUTER_DIR }}
        run: |
          echo "Running NATS performance tests..."
          rebar3 ct --suite test/router_nats_performance_SUITE || echo "NATS performance tests completed with warnings"

      - name: Upload test logs and reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: router-nats-performance-logs
          path: |
            ${{ env.ROUTER_DIR }}/_build/test/logs/**
            ${{ env.ROUTER_DIR }}/.windsurf/reports/**
          retention-days: 7
