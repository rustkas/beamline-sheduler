---
version: 1.0
authors:
  - WORKER wrk-2: Architecture/Tech Lead
last_update: 2025-11-05T22:30:00Z
status: approved
rule_version: v10
message_protocol: v1
---

# CP1: Module Boundaries and Minimal Contracts

## Purpose

Clarification of boundaries between components and approval of minimal contracts for CP1-ROUTER. This document serves as an architectural reference for Gateway and Router implementation.

## Module Boundaries

### Boundary 1: Gateway ⇄ Router

**Protocols**: NATS (Request-Reply) and optionally gRPC

**NATS (Primary)**:
- **Subject**: `beamline.router.v1.decide`
- **Pattern**: Request-Reply
- **Data Format**: JSON (NATS payload) → Protobuf (inside Router)
- **Timeout**: 5 seconds (configurable via policy)

**gRPC (Optional, for future)**:
- **Service**: `beamline.flow.v1.Router.Decide`
- **Data Format**: Protobuf
- **Note**: May be used for direct calls, but not required for CP1

**Gateway Responsibilities**:
- ✅ Accepts HTTP requests from clients
- ✅ Validates and transforms HTTP → NATS JSON
- ✅ Adds correlation fields (`tenant_id`, `trace_id`)
- ✅ Publishes request to `beamline.router.v1.decide`
- ✅ Waits for Router response
- ✅ Transforms NATS JSON → HTTP JSON
- ❌ **Does NOT know** routing business rules
- ❌ **Does NOT make** provider selection decisions

**Router Responsibilities**:
- ✅ Subscribes to `beamline.router.v1.decide`
- ✅ Loads routing policies
- ✅ Applies business rules (weights, sticky, fallback)
- ✅ Makes provider selection decision
- ✅ Returns `RouteDecision` via NATS reply
- ❌ **Does NOT know** about HTTP protocol
- ❌ **Does NOT handle** HTTP requests directly
- ❌ **Does NOT know** about Gateway clients

**Important for CP1**:
- Router may be a **temporary stub** returning fixed decisions
- Interface (NATS subject + Protobuf) must be compatible with future full implementation
- Gateway must work with Router stub without changes

### Boundary 2: Frontend ⇄ Gateway

**Protocol**: HTTP/REST (optionally SSE for streaming)

**Frontend Responsibilities**:
- ✅ Calls Gateway REST API (`/api/v1/*`)
- ✅ Optionally uses SSE for real-time updates
- ✅ Passes `X-Tenant-ID` and `X-Trace-ID` in headers
- ❌ **Does NOT call** Router directly
- ❌ **Does NOT know** about NATS or gRPC

**Gateway Responsibilities**:
- ✅ Provides REST API for Frontend
- ✅ Handles SSE streaming (if required)
- ✅ Validates requests from Frontend
- ✅ Delegates routing to Router via NATS

**Important for CP1**:
- Frontend optionally calls Gateway (may be implemented later)
- Gateway must work without Frontend (for direct API calls)

## Minimal Contract for CP1

### 1. REST API: POST /api/v1/messages

**Request DTO** (TypeScript):
```typescript
interface MessageRequest {
  message_id: string;           // UUID, required
  message_type: "chat" | "completion" | "embedding";  // required
  payload: string;              // Base64 encoded, required
  metadata?: Record<string, any>;  // optional
  policy_id?: string;           // optional, policy override
}
```

**Response DTO** (TypeScript):
```typescript
interface RouteDecisionResponse {
  message_id: string;           // UUID, required
  provider_id: string;           // required, e.g. "openai"
  reason: "weighted" | "sticky" | "fallback" | "policy";  // required
  priority: number;              // 0-100, required
  expected_latency_ms: number;   // required
  expected_cost: number;        // required
  currency: "USD";              // required, fixed value
  trace_id: string;            // required, for correlation
}
```

**HTTP Headers**:
- `X-Tenant-ID`: required (extracted by Gateway from auth context)
- `X-Trace-ID`: optional (generated by Gateway if not provided)

### 2. REST API: POST /api/v1/routes/decide

**Purpose**: Direct Router call for decision making (alternative to `/api/v1/messages`)

**Request DTO** (TypeScript):
```typescript
interface RouteDecideRequest {
  message: {
    message_id: string;
    tenant_id: string;          // required
    trace_id?: string;          // optional
    message_type: string;
    payload: string;             // Base64 encoded
    metadata?: Record<string, string>;
    timestamp_ms?: number;       // optional, Unix timestamp in ms
  };
  policy_id?: string;           // optional
  context?: Record<string, string>;  // optional, for sticky sessions
}
```

**Response DTO**: Same as `RouteDecisionResponse` from `/api/v1/messages`

**Note**: This endpoint may be used for direct Router testing without full message processing cycle.

### 3. Protobuf Messages

**Package**: `beamline.flow.v1`

**Message** (from `proto/beamline/flow/v1/flow.proto`):
```protobuf
message Message {
  string message_id = 1;        // required
  string tenant_id = 2;         // required
  string trace_id = 3;           // optional
  string message_type = 4;       // required
  bytes payload = 5;             // required
  map<string, string> metadata = 6;  // optional
  int64 timestamp_ms = 7;        // optional
}
```

**RouteRequest**:
```protobuf
message RouteRequest {
  Message message = 1;           // required
  string policy_id = 2;          // optional
  map<string, string> context = 3;  // optional
}
```

**RouteDecision**:
```protobuf
message RouteDecision {
  string provider_id = 1;        // required
  string reason = 2;             // required
  int32 priority = 3;            // required, 0-100
  int64 expected_latency_ms = 4; // required
  double expected_cost = 5;      // required
  map<string, string> metadata = 6;  // optional
}
```

**Service**:
```protobuf
service Router {
  rpc Decide(RouteRequest) returns (RouteDecision);
}
```

### Field Optionality and Runtime Validation

**Proto Contract**: All fields are optional (protobuf v3 semantics)

**Runtime Validation**: Router enforces required fields:
- `Message`: `tenant_id`, `message_type`, `payload` (required at runtime)
- `RouteRequest`: `message` (required at runtime)
- `RouteDecision`: `provider_id`, `reason` (required at runtime)

**Rationale**: Proto optionality allows backward compatibility, while runtime validation ensures data quality. Missing required fields result in `invalid_request` error.

### 4. NATS Subjects

**Subject**: `beamline.router.v1.decide`

**Request Format** (JSON):
```json
{
  "message": {
    "message_id": "uuid",
    "tenant_id": "string",
    "trace_id": "string",
    "message_type": "chat|completion|embedding",
    "payload": "base64_encoded_string",
    "metadata": {},
    "timestamp_ms": 1234567890
  },
  "policy_id": "string (optional)",
  "context": {
    "user_id": "string (optional)",
    "session_id": "string (optional)"
  }
}
```

**Response Format** (JSON):
```json
{
  "provider_id": "openai",
  "reason": "weighted|sticky|fallback|policy",
  "priority": 80,
  "expected_latency_ms": 500,
  "expected_cost": 0.01,
  "metadata": {}
}
```

**Pattern**: Request-Reply (NATS core or JetStream)

**Timeout**: 5 seconds (configurable)

## ABI Naming and Versioning

### Protobuf Versioning

**Current version**: `v1` (package `beamline.flow.v1`)

**Rules**:
- **MAJOR** (v1 → v2): Breaking changes (removing fields, changing types)
- **MINOR**: Backward-compatible additions (new optional fields)
- **PATCH**: Not used for Protobuf (only MAJOR/MINOR used)

**Migration**:
- Old versions supported for 90 days after new version release
- Dual support during migration
- Deprecation notice: 90 days before removal

### NATS Subjects Versioning

**Current version**: `v1` (subject `beamline.router.v1.decide`)

**Rules**:
- **MAJOR** (v1 → v2): Breaking changes in message structure
- **MINOR**: Backward-compatible additions (new optional fields)
- Old subjects remain active during migration

### REST API Versioning

**Current version**: `v1` (URL `/api/v1/*`)

**Rules**:
- **MAJOR** (v1 → v2): Breaking changes (removing endpoints, changing structure)
- **MINOR**: Backward-compatible additions (new optional fields, new endpoints)
- Old versions supported for 90 days

## Router as Temporary Stub

### Stub Requirements

**For CP1 Router may be implemented as a stub**:

1. **Interface compatible**:
   - Subscribes to `beamline.router.v1.decide`
   - Returns response in `RouteDecision` format (JSON)
   - Uses same fields and structure

2. **Minimal logic**:
   - May return fixed `provider_id` (e.g., "openai")
   - May return fixed `reason` (e.g., "policy")
   - May return fixed `expected_latency_ms` and `expected_cost`

3. **Future compatibility**:
   - Interface (NATS subject + Protobuf) does not change
   - Gateway works without changes when stub is replaced with full implementation
   - All fields in `RouteDecision` are present (even with fixed values)

### Stub Example

**Erlang/OTP Router Stub**:
```erlang
handle_route_request(RouteRequest) ->
    % Minimal stub for CP1
    #{
        provider_id => "openai",
        reason => "policy",
        priority => 80,
        expected_latency_ms => 500,
        expected_cost => 0.01,
        metadata => #{}
    }.
```

**Important**: Stub must validate input data and return correct response format.

## Integrations and Boundaries (Detailed)

### Gateway → Router (NATS)

**Protocol**: JSON over NATS Request-Reply

**Transformation**:
1. Gateway receives HTTP POST `/api/v1/messages`
2. Gateway extracts `X-Tenant-ID` from headers (or from auth context)
3. Gateway generates/uses `X-Trace-ID`
4. Gateway transforms HTTP JSON → NATS JSON:
   ```json
   {
     "message": {
       "message_id": "...",
       "tenant_id": "...",  // from X-Tenant-ID
       "trace_id": "...",   // from X-Trace-ID
       "message_type": "...",
       "payload": "...",    // Base64
       "metadata": {}
     },
     "policy_id": "..."  // optional
   }
   ```
5. Gateway publishes to `beamline.router.v1.decide`
6. Gateway waits for response in reply subject
7. Gateway transforms NATS JSON → HTTP JSON

**Errors**:
- If Router does not respond (timeout): Gateway returns 503 Service Unavailable
- If Router returns error: Gateway returns 500 Internal Server Error
- If NATS unavailable: Gateway returns 503 Service Unavailable

### Router → Gateway (NATS Reply)

**Protocol**: JSON over NATS Reply

**Transformation**:
1. Router receives NATS JSON request
2. Router validates structure (may parse to Protobuf for validation)
3. Router applies routing logic (or returns stub)
4. Router forms response:
   ```json
   {
     "provider_id": "...",
     "reason": "...",
     "priority": 80,
     "expected_latency_ms": 500,
     "expected_cost": 0.01,
     "metadata": {}
   }
   ```
5. Router publishes response to NATS reply subject

### Frontend → Gateway (HTTP/REST)

**Protocol**: HTTP/REST (optionally SSE)

**Transformation**:
1. Frontend calls `POST /api/v1/messages` with JSON body
2. Frontend passes `X-Tenant-ID` and `X-Trace-ID` in headers
3. Gateway validates request
4. Gateway delegates to Router via NATS
5. Gateway returns HTTP JSON response

**Important**: Frontend does not know about NATS or Router, works only through Gateway REST API.

## Protocols: External vs Internal

### External Protocols (Gateway ↔ Clients)

- **HTTP/REST**: JSON format
- **SSE**: Server-Sent Events for streaming (optional for CP1)

### Internal Protocols (Gateway ↔ Router ↔ Provider)

- **NATS**: JSON payload (for Request-Reply)
- **Protobuf**: Binary format (for gRPC, optional for CP1)
- **gRPC**: Protobuf over HTTP/2 (optional for CP1)

**Important**: Gateway transforms HTTP JSON ↔ NATS JSON, Router works with Protobuf internally (but accepts JSON via NATS).

## Architectural Review Checklist

### CP1 Compliance

**✅ Included in CP1**:
- Gateway REST API (`/api/v1/messages`, `/api/v1/routes/decide`)
- NATS integration (`beamline.router.v1.decide`)
- Router stub with compatible interface
- Protobuf definitions (`beamline.flow.v1`)
- Basic DTO structures

**❌ NOT included in CP1** (reject "golden" improvements):
- Full Router implementation with policies (stub only)
- gRPC integration (optional, not required)
- Frontend implementation (optional)
- Observability (Prometheus/OTel) - excluded from CP1 (CP1 limits to baseline: JSON logs + /_health)
- Complex routing logic (basic stub only)
- Rate limiting (optional for CP1)
- Sticky sessions (optional for CP1)

### Boundaries Respected

**✅ Gateway does not "peek" into Router logic**:
- Gateway does not know about routing policies
- Gateway does not know about providers
- Gateway only transforms HTTP ↔ NATS

**✅ Router does not pull HTTP**:
- Router does not handle HTTP requests
- Router works only with NATS (and optionally gRPC)
- Router does not know about Gateway or clients

**✅ Frontend optionally calls Gateway**:
- Frontend may be implemented later
- Gateway works without Frontend (for direct API calls)

### ADR Compliance

**✅ ADR-010 (Target Architecture)**:
- Module boundaries respected
- Protocols match (NATS for Gateway ↔ Router)
- Responsibilities correctly separated

**✅ ADR-004 (Erlang/OTP Router)**:
- Router may be stub for CP1
- Interface compatible with future implementation
- gRPC service defined (but optional for CP1)

**✅ ADR-006 (NATS Inter-Service Communication)**:
- NATS subject `beamline.router.v1.decide` used
- Request-Reply pattern applied
- Message format matches

**✅ CP1_ROUTER_SPEC.md**:
- Minimal requirements met
- Stub allowed for CP1
- Interface ready for future implementation

## Acceptance Criteria

### Functional

1. ✅ Gateway implements `POST /api/v1/messages` with correct DTOs
2. ✅ Gateway implements `POST /api/v1/routes/decide` (optional)
3. ✅ Gateway publishes requests to `beamline.router.v1.decide`
4. ✅ Router (stub) subscribes to `beamline.router.v1.decide`
5. ✅ Router returns correct `RouteDecision` format
6. ✅ Protobuf definitions match contract

### Non-Functional

1. ✅ Module boundaries respected (Gateway does not know Router logic, Router does not know HTTP)
2. ✅ Interface compatible with future Router implementation
3. ✅ ABI versioning defined (v1 for all components)
4. ✅ All changes fit within ADR-010/004/006 and CP1_ROUTER_SPEC.md

### Architectural

1. ✅ No CP1 scope expansion ("golden" improvements rejected)
2. ✅ Router may be stub without breaking interface
3. ✅ Frontend optional (Gateway works without it)
4. ✅ Observability limited to baseline in CP1 (Prometheus/OTel reserved for CP2)

### BeamLine Vision Alignment

- CP1 boundaries and contracts must remain consistent with the overall BeamLine product/architecture vision.
- See `docs/BEAMLINE_VISION_AND_ARCHITECTURE.md` for the high-level vision and architecture map.

## References

- `docs/ADR/ADR-010-target-architecture.md`: Target architecture
- `docs/ADR/ADR-004-erlang-otp-router.md`: Router decision
- `docs/ADR/ADR-006-nats-inter-service-communication.md`: NATS decision
- `docs/CP1_ROUTER_SPEC.md`: CP1 Router specification
- `docs/NATS_SUBJECTS.md`: NATS subjects catalog
- `docs/ARCHITECTURE/api-registry.md`: API registry
- `docs/ARCHITECTURE/compatibility-rules.md`: Compatibility rules
- `proto/beamline/flow/v1/flow.proto`: Protobuf ABI
- `docs/GATEWAY_ROUTES.md`: Gateway routes specification
